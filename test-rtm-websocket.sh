#!/bin/bash

echo "üß™ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ç–µ—Å—Ç—ñ–≤ RTM —Ç–∞ WebSocket —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ..."
echo "=================================================="

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–≤–æ–¥—É —Å—Ç–∞—Ç—É—Å—É
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}‚úÖ $2${NC}"
    else
        echo -e "${RED}‚ùå $2${NC}"
        exit 1
    fi
}

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
echo -e "${YELLOW}üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π...${NC}"

# Backend —Ç–µ—Å—Ç–∏
echo -e "${YELLOW}üß™ –ó–∞–ø—É—Å–∫ backend —Ç–µ—Å—Ç—ñ–≤...${NC}"
cd apps/server

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
if [ ! -d "node_modules" ]; then
    echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è backend –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
    npm install
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–µ—Å—Ç–∏ RTM —Å–µ—Ä–≤—ñ—Å—É
echo "üîå –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è RTM —Å–µ—Ä–≤—ñ—Å—É..."
npm test -- rtm.service.spec.ts --verbose
print_status $? "RTM Service —Ç–µ—Å—Ç–∏"

# –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–µ—Å—Ç–∏ ChatsGateway
echo "üåê –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è ChatsGateway..."
npm test -- chats.gateway.spec.ts --verbose
print_status $? "ChatsGateway —Ç–µ—Å—Ç–∏"

# Frontend —Ç–µ—Å—Ç–∏
echo -e "${YELLOW}üß™ –ó–∞–ø—É—Å–∫ frontend —Ç–µ—Å—Ç—ñ–≤...${NC}"
cd ../web

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
if [ ! -d "node_modules" ]; then
    echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è frontend –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
    npm install
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–µ—Å—Ç–∏ WebSocket Pool
echo "üîó –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è WebSocket Pool..."
npm test -- WebSocketPoolContext.test.tsx --verbose
print_status $? "WebSocket Pool —Ç–µ—Å—Ç–∏"

# –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–µ—Å—Ç–∏ Toast –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
echo "üçû –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è Toast –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞..."
npm test -- Toast.test.tsx --verbose
print_status $? "Toast –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–µ—Å—Ç–∏"

# –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –≤ –∫–æ—Ä—ñ–Ω—å –ø—Ä–æ–µ–∫—Ç—É
cd ../..

echo ""
echo -e "${GREEN}üéâ –í—Å—ñ —Ç–µ—Å—Ç–∏ –ø—Ä–æ–π—à–ª–∏ —É—Å–ø—ñ—à–Ω–æ!${NC}"
echo "=================================================="
echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è:"
echo "  ‚úÖ RTM Service - –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è, –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –ø—ñ–¥–ø–∏—Å–∫–∏"
echo "  ‚úÖ ChatsGateway - WebSocket –ø–æ–¥—ñ—ó, RTM —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è"
echo "  ‚úÖ WebSocket Pool - —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑'—î–¥–Ω–∞–Ω–Ω—è–º–∏, –¥—ñ–∞–ª–æ–≥–∏"
echo "  ‚úÖ Toast Component - —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è, –∞–Ω—ñ–º–∞—Ü—ñ—ó, –≤–∑–∞—î–º–æ–¥—ñ—è"
echo ""
echo -e "${YELLOW}üí° –°–∏—Å—Ç–µ–º–∞ RTM + WebSocket –≥–æ—Ç–æ–≤–∞ –¥–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!${NC}"
