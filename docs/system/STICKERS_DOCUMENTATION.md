# üìã –î–û–ö–£–ú–ï–ù–¢–ê–¶–Ü–Ø –°–ò–°–¢–ï–ú–ò –°–¢–Ü–ö–ï–†–Ü–í

## –û–≥–ª—è–¥

–°–∏—Å—Ç–µ–º–∞ —Å—Ç—ñ–∫–µ—Ä—ñ–≤ –∑–∞–±–µ–∑–ø–µ—á—É—î –ø–æ–≤–Ω—É —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –∑ TalkyTimes API –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è, –≤–∏–±–æ—Ä—É —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å—Ç—ñ–∫–µ—Ä—ñ–≤ –≤ —á–∞—Ç—ñ. –í–∫–ª—é—á–∞—î –∫–µ—à—É–≤–∞–Ω–Ω—è, UX —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ —Ç–∞ —Å—É—á–∞—Å–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

## –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

#### Frontend (`apps/web/src/app/chats/[dialogId]/page.tsx`)
```typescript
// –ö–ª—é—á–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
- loadStickers()         // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç—ñ–∫–µ—Ä—ñ–≤ –∑ –∫–µ—à—É–≤–∞–Ω–Ω—è–º
- handleStickerSelect()  // –û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É —Å—Ç—ñ–∫–µ—Ä–∞
- renderMessage()        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑—ñ —Å—Ç—ñ–∫–µ—Ä–∞–º–∏
- clearStickersCache()   // –û—á–∏—â–µ–Ω–Ω—è –∫–µ—à–∞
```

#### Backend (`apps/server/src/`)
```typescript
// –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä (chats.controller.ts)
- @Post('stickers') getStickers()      // –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç—ñ–∫–µ—Ä—ñ–≤
- @Post('send-sticker') sendSticker()  // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å—Ç—ñ–∫–µ—Ä–∞

// –°–µ—Ä–≤—ñ—Å (chats.service.ts)
- getStickers()     // –ë—ñ–∑–Ω–µ—Å –ª–æ–≥—ñ–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç—ñ–∫–µ—Ä—ñ–≤
- sendSticker()     // –ë—ñ–∑–Ω–µ—Å –ª–æ–≥—ñ–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å—Ç—ñ–∫–µ—Ä–∞

// –ü—Ä–æ–≤–∞–π–¥–µ—Ä (talkytimes.provider.ts)
- getStickers()        // API –∑–∞–ø–∏—Ç –¥–æ TalkyTimes
- sendStickerById()    // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å—Ç—ñ–∫–µ—Ä–∞ –∑–∞ ID
- stickersCache: Map   // –ö–µ—à —Å—Ç—ñ–∫–µ—Ä—ñ–≤ (30 —Ö–≤)
```

## API –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è

### –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç—ñ–∫–µ—Ä—ñ–≤
```http
POST https://talkytimes.com/platform/chat/stickers
Content-Type: application/json
Cookie: tld-token=...; tu_auth=...

{
  "idInterlocutor": 123456789
}
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "categories": [
    {
      "name": "Funny Faces",
      "stickers": [
        {
          "id": 1001,
          "url": "https://i.gstatvb.com/sticker_1001.jpg"
        }
      ]
    }
  ]
}
```

### –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å—Ç—ñ–∫–µ—Ä–∞
```http
POST https://talkytimes.com/platform/chat/send/sticker
Content-Type: application/json
Cookie: tld-token=...; tu_auth=...

{
  "idSticker": 1001,
  "idRegularUser": 123456789
}
```

## –ö–µ—à—É–≤–∞–Ω–Ω—è

### –î–≤–æ—à–∞—Ä–æ–≤–µ –∫–µ—à—É–≤–∞–Ω–Ω—è

#### –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–µ—à
```typescript
const stickersCache = useRef<{
  data: StickerCategory[];
  timestamp: number;
  profileId: string;
} | null>(null);

const STICKERS_CACHE_TTL = 30 * 60 * 1000; // 30 —Ö–≤–∏–ª–∏–Ω
```

#### –ë–µ–∫–µ–Ω–¥ –∫–µ—à
```typescript
private stickersCache = new Map<string, {
  data: any;
  timestamp: number;
}>();

private readonly STICKERS_CACHE_TTL = 30 * 60 * 1000;
```

### –°—Ç—Ä–∞—Ç–µ–≥—ñ—è –∫–µ—à—É–≤–∞–Ω–Ω—è
1. **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–µ—à–∞** –ø–µ—Ä–µ–¥ API –∑–∞–ø–∏—Ç–æ–º
2. **–ó–≤'—è–∑–æ–∫ –∑ –ø—Ä–æ—Ñ—ñ–ª–µ–º** - –æ–∫—Ä–µ–º–∏–π –∫–µ—à –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é
3. **TTL 30 —Ö–≤–∏–ª–∏–Ω** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
4. **–û—á–∏—â–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö** - –≥–∞—Ä–∞–Ω—Ç—ñ—è —Å–≤—ñ–∂–∏—Ö –¥–∞–Ω–∏—Ö

## UX/UI

### –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
- **–†–æ–∑–º—ñ—Ä**: `max-w-7xl w-full max-h-[85vh]`
- **–ó–∞–∫—Ä–∏—Ç—Ç—è**: Escape + backdrop click
- **–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó**: –ª—ñ–≤–∏–π —Å–∞–π–¥–±–∞—Ä –∑ –º—ñ–Ω—ñ–∞—Ç—é—Ä–∞–º–∏
- **–°—ñ—Ç–∫–∞**: responsive grid (3-12 –∫–æ–ª–æ–Ω–æ–∫)

### –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ —Å—Ç–∞—Ç—É—Å—É
```typescript
// –í—ñ–¥–ø—Ä–∞–≤–∫–∞
<div className="w-4 h-4 bg-blue-500 rounded-full flex items-center justify-center">
  <div className="w-2 h-2 border border-white border-t-transparent rounded-full animate-spin"></div>
</div>

// –ü–æ–º–∏–ª–∫–∞
<div className="w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
  <svg className="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
    <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
  </svg>
</div>
```

### –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç—ñ–∫–µ—Ä—ñ–≤
- **–†–æ–∑–º—ñ—Ä**: `max-w-[124px] max-h-[124px]`
- **–ü—Ä–æ–ø–æ—Ä—Ü—ñ—ó**: `object-contain`
- **–°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è**: `rounded-md`
- **–ê–Ω—ñ–º–∞—Ü—ñ—ó**: hover scale + transition

## –¢–∏–ø–∏ –¥–∞–Ω–∏—Ö

```typescript
interface Sticker {
  id: number;
  url: string;
}

interface StickerCategory {
  name: string;
  stickers: Sticker[];
}

interface ChatMessage {
  id: number;
  type: 'sticker' | 'text' | 'photo';
  content: {
    id?: number;     // –î–ª—è —Å—Ç—ñ–∫–µ—Ä—ñ–≤
    url?: string;    // –î–ª—è —Å—Ç—ñ–∫–µ—Ä—ñ–≤/—Ñ–æ—Ç–æ
    message?: string; // –î–ª—è —Ç–µ–∫—Å—Ç—É
  };
  isSending?: boolean;  // –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
  error?: boolean;      // –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–º–∏–ª–∫–∏
}
```

## –õ–æ–≥—É–≤–∞–Ω–Ω—è

```
üì• Loading stickers from server...
‚úÖ Loaded 3 sticker categories and cached them
üìã Using cached stickers (age: 45 seconds)
üìã Using cached stickers for profile 7162437 (age: 120s)
üòÄ TalkyTimes.getStickers: profileId=7162437, interlocutorId=123456
```

## –ü–æ–º–∏–ª–∫–∏ —Ç–∞ —ó—Ö –≤–∏—Ä—ñ—à–µ–Ω–Ω—è

### 403 Forbidden –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ —Å—Ç—ñ–∫–µ—Ä–∞
**–°–∏–º–ø—Ç–æ–º–∏:** `POST /api/chats/send-sticker` –ø–æ–≤–µ—Ä—Ç–∞—î 403
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π `idProfile` –≤ –∑–∞–ø–∏—Ç—ñ
**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–∞—Ä—Å–∏–Ω–≥ `dialogId` —Ç–∞ –ø–µ—Ä–µ–¥–∞—á—É `idProfile`

### –ö–µ—à –Ω–µ –ø—Ä–∞—Ü—é—î
**–°–∏–º–ø—Ç–æ–º–∏:** –°—Ç—ñ–∫–µ—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∫–æ–∂–Ω–æ–≥–æ —Ä–∞–∑—É
**–ü—Ä–∏—á–∏–Ω–∞:** –ó–º—ñ–Ω–∞ –ø—Ä–æ—Ñ—ñ–ª—é –∞–±–æ –ø–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
**–†—ñ—à–µ–Ω–Ω—è:** –ö–µ—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—á–∏—â–∞—î—Ç—å—Å—è, —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑

### –°—Ç—ñ–∫–µ—Ä –Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è
**–°–∏–º–ø—Ç–æ–º–∏:** –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∏–ø—É `sticker` –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö
**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ `content.url` —Ç–∞ `content.id`

## –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

### –ú–µ—Ç—Ä–∏–∫–∏
- **–ó–∞–ø–∏—Ç—ñ–≤ –¥–æ API**: -70% –∑–∞–≤–¥—è–∫–∏ –∫–µ—à—É–≤–∞–Ω–Ω—é
- **–ß–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è**: –º–∏—Ç—Ç—î–≤–∏–π –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ –∑–∞–ø–∏—Ç—É
- **–†–æ–∑–º—ñ—Ä —Å—Ç—ñ–∫–µ—Ä—ñ–≤**: –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ –¥–æ 124x124px
- **–ü–∞–º'—è—Ç—å**: –∫–µ—à –æ—á–∏—â–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ

### –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
1. **Lazy loading** –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö —Å–ø–∏—Å–∫—ñ–≤ —Å—Ç—ñ–∫–µ—Ä—ñ–≤
2. **Intersection Observer** –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
3. **WebP/AVIF** –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –¥–ª—è —Å—Ç—ñ–∫–µ—Ä—ñ–≤
4. **Service Worker** –¥–ª—è –æ—Ñ–ª–∞–π–Ω –∫–µ—à—É–≤–∞–Ω–Ω—è

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### Mock –¥–∞–Ω—ñ
```typescript
const mockCategories = [
  {
    name: 'Test Category',
    stickers: [
      { id: 1001, url: 'https://via.placeholder.com/64x64?text=üòÄ' }
    ]
  }
];
```

### Test cases
1. ‚úÖ –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç—ñ–∫–µ—Ä—ñ–≤ –≤ —á–∞—Ç—ñ
2. ‚úÖ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å—Ç—ñ–∫–µ—Ä–∞ –∑ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏
3. ‚úÖ –ö–µ—à—É–≤–∞–Ω–Ω—è –ø—Ä–∞—Ü—é—î 30 —Ö–≤–∏–ª–∏–Ω
4. ‚úÖ –ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ Escape + backdrop
5. ‚úÖ –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
6. ‚úÖ Responsive –¥–∏–∑–∞–π–Ω

## –ú–∞–π–±—É—Ç–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

### Planned Features
- **–ü–æ—à—É–∫ —Å—Ç—ñ–∫–µ—Ä—ñ–≤** –ø–æ –Ω–∞–∑–≤—ñ/–µ–º–æ—Ü—ñ—è—Ö
- **–û—Å—Ç–∞–Ω–Ω—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ** —Å—Ç—ñ–∫–µ—Ä–∏
- **–ö–∞—Å—Ç–æ–º–Ω—ñ —Å—Ç—ñ–∫–µ—Ä–∏** –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- **GIF –ø—ñ–¥—Ç—Ä–∏–º–∫–∞** –¥–ª—è –∞–Ω—ñ–º–æ–≤–∞–Ω–∏—Ö —Å—Ç—ñ–∫–µ—Ä—ñ–≤
- **–†–µ–∞–∫—Ü—ñ—ó** –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è

### Technical Debt
- [ ] Unit —Ç–µ—Å—Ç–∏ –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ —Å—Ç—ñ–∫–µ—Ä—ñ–≤
- [ ] E2E —Ç–µ—Å—Ç–∏ –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ —Ñ–ª–æ—É
- [ ] TypeScript strict mode –¥–ª—è –≤—Å—ñ—Ö —Ç–∏–ø—ñ–≤
- [ ] Performance monitoring –¥–ª—è –∫–µ—à–∞

---

*–û—Å—Ç–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: $(date)*
*–í–µ—Ä—Å—ñ—è: 1.0.0*</content>
</xai:function_call">–°–∏—Å—Ç–µ–º–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: –§–∞–π–ª —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!
